import SwiftUI

struct SignUpPopupView: View {
    let closeAction: () -> Void
    let onAuthenticated: () -> Void

    @EnvironmentObject var userSession: UserSession

    @State private var firstName = ""
    @State private var lastName  = ""
    @State private var email     = ""
    @State private var phone     = ""
    @State private var birthday  = ""
    @State private var password  = ""
    @State private var confirmPassword = ""

    private let cream = Color(red: 0.969, green: 0.949, blue: 0.929)
    private let dark  = Color(red: 0.145, green: 0.098, blue: 0.051)
    private let gold  = Color(red: 0.851, green: 0.537, blue: 0.157)

    var body: some View {
        ZStack(alignment: .topTrailing) {
            ScrollView(showsIndicators: false) {
                VStack(spacing: 24) {
                    Text("SIGN UP")
                        .font(.custom("Konkhmer Sleokchher", size: 18))
                        .foregroundColor(dark)
                        .padding(.top, 60)

                    // fields
                    floatingField("First Name", text: $firstName)
                    floatingField("Last Name",  text: $lastName)
                    floatingField("Email",      text: $email)
                    floatingField("Phone Number", text: $phone)
                    floatingField("Birthday",   text: $birthday)
                    floatingField("Password",   text: $password, secure: true)
                    floatingField("Confirm Password", text: $confirmPassword, secure: true)

                    Button {
                        // ðŸ”— push into session so AccountMainView + greeting use it
                        userSession.firstName = firstName
                        userSession.lastName  = lastName
                        userSession.email     = email
                        userSession.phone     = phone
                        userSession.birthday  = birthday
                        userSession.password  = password   // fine for prototype

                        userSession.isLoggedIn = true
                        onAuthenticated()
                        closeAction()
                    } label: {
                        Text("CREATE ACCOUNT")
                            .font(.custom("Konkhmer Sleokchher", size: 15))
                            .foregroundColor(.white)
                            .frame(maxWidth: .infinity)
                            .padding(.vertical, 18)
                            .background(
                                RoundedRectangle(cornerRadius: 40)
                                    .fill(gold)
                            )
                    }
                    .padding(.top, 40)

                    Spacer().frame(height: 30)
                }
                .padding(.horizontal, 40)
                .padding(.bottom, 60)
            }

            // CLOSE X
            Button(action: closeAction) {
                Image(systemName: "xmark")
                    .foregroundColor(dark)
                    .font(.system(size: 22, weight: .bold))
            }
            .padding(.top, 48)
            .padding(.trailing, 32)
        }
    }

    @ViewBuilder
    private func floatingField(_ label: String,
                               text: Binding<String>,
                               secure: Bool = false) -> some View {
        ZStack(alignment: .leading) {
            // floating label
            Text(label)
                .font(.custom("Konkhmer Sleokchher", size: 13))
                .foregroundColor(dark.opacity(text.wrappedValue.isEmpty ? 0.35 : 1))
                .offset(y: text.wrappedValue.isEmpty ? 0 : -22)
                .scaleEffect(text.wrappedValue.isEmpty ? 1.0 : 0.9, anchor: .leading)
                .animation(.spring(response: 0.35, dampingFraction: 0.9),
                           value: text.wrappedValue)

            VStack(alignment: .leading, spacing: 6) {
                Spacer().frame(height: 8)

                if secure {
                    SecureField("", text: text)
                        .textInputAutocapitalization(.never)
                        .keyboardType(.default)
                } else {
                    TextField("", text: text)
                        .textInputAutocapitalization(.never)
                        .keyboardType(.default)
                }

                Rectangle()
                    .frame(height: 1)
                    .foregroundColor(text.wrappedValue.isEmpty ? dark : gold)
                    .opacity(0.85)
            }
        }
        .padding(.top, 18)
    }
}
